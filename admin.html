<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Vini - Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap');

        :root {
            --primary-color: #5d0f10;
            --secondary-color: #2a619e;
            --text-color: #333;
            --bg-color: #f4f4f4;
            --unavailable-color: #ccc;
        }

        body {
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            background-color: var(--bg-color);
        }
        
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Stile per la schermata di login */
        #login-container {
            text-align: center;
            padding: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #login-container h1 {
            text-align: center;
            color: var(--primary-color);
            font-family: 'Playfair Display', serif;
        }

        #login-container input {
            padding: 15px;
            margin: 10px 0;
            width: 80%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1.2em;
            box-sizing: border-box;
            text-align: center;
        }

        #login-container button {
            padding: 10px 20px;
            margin-top: 10px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        #login-container button:hover {
            background-color: #4a0b0b;
        }
        
        #error-message {
            color: var(--primary-color);
            margin-top: 10px;
        }

        #main-content {
            display: none; /* Inizialmente nascosto */
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-family: 'Playfair Display', serif;
        }
        
        #admin-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 10px;
        }

        #search-input {
            flex-grow: 1;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            min-width: 150px;
        }

        .toggle-button {
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .toggle-button:hover {
            background-color: #1a4a7a;
        }

        .wine-category-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5em;
            color: var(--secondary-color);
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 5px;
            display: block;
        }

        .wine-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .wine-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .wine-item:hover {
            background-color: #f9f9f9;
        }

        .wine-item:last-child {
            border-bottom: none;
        }

        .wine-name {
            flex-grow: 1;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1.4;
        }

        /* Stili per il nuovo indicatore a pallino */
        .availability-bullet {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            transition: background-color 0.3s;
            flex-shrink: 0;
        }

        .availability-bullet.available {
            background-color: #4CAF50; /* Verde */
        }

        .availability-bullet.unavailable {
            background-color: var(--unavailable-color); /* Grigio */
        }
        
        .stock-count {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--text-color);
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            font-style: italic;
            color: #777;
            padding: 20px;
        }

        /* --- STILI PER LA MODAL DI EDITING --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-content form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1em;
        }

        .modal-content form input,
        .modal-content form textarea,
        .modal-content form select {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        .modal-content form textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .modal-content form input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
        }
        
        #save-button {
            background-color: #4CAF50;
        }
        
        #save-button:hover {
            background-color: #45a049;
        }

        #cancel-button {
            background-color: #f44336;
        }
        
        #cancel-button:hover {
            background-color: #d32f2f;
        }

    </style>
</head>
<body>

<div class="container">
    <div id="login-container">
        <h1>Gestione Carta Vini</h1>
        <input type="password" id="password-input" placeholder="Inserisci la password">
        <button id="login-button">Accedi</button>
        <div id="error-message"></div>
    </div>

    <div id="main-content">
        <h1>Gestione Vini</h1>
        
        <div id="admin-controls">
            <input type="text" id="search-input" placeholder="Cerca vino per nome, AOC o vitigni...">
            <button id="edit-mode-button" class="toggle-button">Modifica Dati Vino</button>
        </div>

        <div id="loading-message" class="loading" style="display:none;">Caricamento vini...</div>
        <div id="wine-list-container"></div>
        <div id="message" class="message"></div>
    </div>
</div>

<!-- Modal per la modifica dei dati -->
<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title">Modifica Vino</h2>
        <form id="edit-form">
            <input type="hidden" id="edit-nome-originale">
            
            <label for="edit-categoria">Categoria:</label>
            <input type="text" id="edit-categoria" name="Categoria" required>
            
            <label for="edit-nazione">Nazione:</label>
            <input type="text" id="edit-nazione" name="Nazione" required>

            <label for="edit-nome">Nome:</label>
            <input type="text" id="edit-nome" name="Nome" required>
            
            <label for="edit-anno">Anno:</label>
            <input type="number" id="edit-anno" name="Anno">

            <label for="edit-aoc">AOC:</label>
            <input type="text" id="edit-aoc" name="AOC">

            <label for="edit-vitigni">Vitigni:</label>
            <input type="text" id="edit-vitigni" name="Vitigni">

            <label for="edit-prezzo">Prezzo:</label>
            <input type="number" step="0.01" id="edit-prezzo" name="Prezzo">
            
            <label for="edit-giacenza">Giacenza:</label>
            <input type="number" id="edit-giacenza" name="Giacenza">

            <label for="edit-descrizione">Descrizione:</label>
            <textarea id="edit-descrizione" name="Descrizione"></textarea>

            <div class="modal-buttons">
                <button type="button" id="cancel-button">Annulla</button>
                <button type="submit" id="save-button">Salva Modifiche</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbwIhY-mG3pIMos7nFjF-B382QwK8ROqc8TBFC9PJtpVi4IfPw1ug-2ajhKSB_Vl5LNh/exec';
        
        // ELEMENTI PER IL LOGIN
        const loginContainer = document.getElementById('login-container');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        
        // ELEMENTI PER LA PAGINA ADMIN
        const wineListContainer = document.getElementById('wine-list-container');
        const messageDiv = document.getElementById('message');
        const searchInput = document.getElementById('search-input');
        const loadingMessage = document.getElementById('loading-message');
        const editModeButton = document.getElementById('edit-mode-button');
        let allWines = [];
        let isEditMode = false;
        
        // ELEMENTI PER LA MODAL DI EDITING
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const cancelButton = document.getElementById('cancel-button');
        const editNomeOriginale = document.getElementById('edit-nome-originale');
        
        // IMPOSTA LA TUA PASSWORD QUI
        const adminPassword = 'Autocarro38';

        loginButton.addEventListener('click', () => {
            if (passwordInput.value === adminPassword) {
                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                fetchWines();
            } else {
                errorMessage.textContent = 'Password errata. Riprova.';
            }
        });
        
        // Permetti il login premendo Invio
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });
        
        // Toggle della modalità di modifica
        editModeButton.addEventListener('click', () => {
            isEditMode = !isEditMode;
            editModeButton.textContent = isEditMode ? 'Modalità Disponibilità' : 'Modifica Dati Vino';
            editModeButton.style.backgroundColor = isEditMode ? '#d32f2f' : var(--secondary-color);
            groupAndRenderWines(allWines); // Ricarica la lista per mostrare la nuova modalità
        });

        // --- FUNZIONI DI GESTIONE DEI VINI ---

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            messageDiv.style.opacity = '1';
            setTimeout(() => {
                messageDiv.style.opacity = '0';
            }, 3000);
        }

        function groupAndRenderWines(wines) {
            wineListContainer.innerHTML = '';
            
            const groupedWines = wines.reduce((acc, wine) => {
                const category = wine.Categoria;
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(wine);
                return acc;
            }, {});

            for (const category in groupedWines) {
                const categorySection = document.createElement('div');
                const categoryTitle = document.createElement('h2');
                categoryTitle.className = 'wine-category-title';
                categoryTitle.textContent = category;
                categorySection.appendChild(categoryTitle);

                const wineList = document.createElement('ul');
                wineList.className = 'wine-list';
                
                groupedWines[category].forEach(wine => {
                    const listItem = document.createElement('li');
                    listItem.className = 'wine-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'wine-name';
                    nameSpan.textContent = wine.Nome;
                    listItem.appendChild(nameSpan);

                    if (isEditMode) {
                        const stockSpan = document.createElement('span');
                        stockSpan.className = 'stock-count';
                        stockSpan.textContent = wine.Giacenza;
                        listItem.appendChild(stockSpan);
                        
                        listItem.addEventListener('click', () => {
                            openEditModal(wine);
                        });
                        
                    } else {
                        const bulletSpan = document.createElement('span');
                        bulletSpan.className = 'availability-bullet';
                        if (wine.Disponibile === true) {
                            bulletSpan.classList.add('available');
                        } else {
                            bulletSpan.classList.add('unavailable');
                        }
                        listItem.appendChild(bulletSpan);

                        listItem.addEventListener('click', () => {
                            const newAvailability = bulletSpan.classList.contains('unavailable');
                            
                            // Aggiorna immediatamente l'interfaccia
                            if (newAvailability) {
                                bulletSpan.classList.remove('unavailable');
                                bulletSpan.classList.add('available');
                            } else {
                                bulletSpan.classList.remove('available');
                                bulletSpan.classList.add('unavailable');
                            }

                            // Invia la richiesta al server
                            updateAvailability(wine.Nome, newAvailability)
                                .then(success => {
                                    if (success) {
                                        showMessage('Vino aggiornato con successo!', 'success');
                                    } else {
                                        // Se l'aggiornamento fallisce, ripristina lo stato visivo
                                        showMessage('Errore durante l\'aggiornamento.', 'error');
                                        if (newAvailability) {
                                            bulletSpan.classList.remove('available');
                                            bulletSpan.classList.add('unavailable');
                                        } else {
                                            bulletSpan.classList.remove('unavailable');
                                            bulletSpan.classList.add('available');
                                        }
                                    }
                                });
                        });
                    }

                    wineList.appendChild(listItem);
                });

                categorySection.appendChild(wineList);
                wineListContainer.appendChild(categorySection);
            }
        }

        function fetchWines() {
            loadingMessage.style.display = 'block';
            wineListContainer.style.display = 'none';

            fetch(appsScriptUrl)
                .then(response => response.json())
                .then(wines => {
                    allWines = wines;
                    groupAndRenderWines(allWines);
                    loadingMessage.style.display = 'none';
                    wineListContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei vini:', error);
                    loadingMessage.textContent = 'Errore nel caricamento dei dati.';
                });
        }
        
        function filterWines(query) {
            const lowerCaseQuery = query.toLowerCase();
            const filteredWines = allWines.filter(wine => {
                const nameMatch = wine.Nome && wine.Nome.toLowerCase().includes(lowerCaseQuery);
                const categoryMatch = wine.Categoria && wine.Categoria.toLowerCase().includes(lowerCaseQuery);
                const aocMatch = wine.AOC && wine.AOC.toLowerCase().includes(lowerCaseQuery);
                const vitigniMatch = wine.Vitigni && wine.Vitigni.toLowerCase().includes(lowerCaseQuery);
                return nameMatch || categoryMatch || aocMatch || vitigniMatch;
            });
            groupAndRenderWines(filteredWines);
        }
        
        searchInput.addEventListener('input', (e) => {
            filterWines(e.target.value);
        });

        // Funzione per aggiornare la sola disponibilità
        function updateAvailability(nome, disponibilita) {
            const data = { nome, disponibilita, action: 'updateAvailability' };
            return fetch(appsScriptUrl, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors'
            })
            .then(() => true)
            .catch(error => {
                console.error('Errore nell\'aggiornamento della disponibilità:', error);
                return false;
            });
        }
        
        // Funzione per aggiornare tutti i dati
        function updateWineData(nomeOriginale, newData) {
             const data = { nome: nomeOriginale, newData, action: 'updateWineData' };
            return fetch(appsScriptUrl, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors'
            })
            .then(() => true)
            .catch(error => {
                console.error('Errore nell\'aggiornamento dei dati:', error);
                return false;
            });
        }

        // --- GESTIONE MODAL DI EDITING ---

        function openEditModal(wine) {
            editModal.style.display = 'flex';
            editNomeOriginale.value = wine.Nome;
            document.getElementById('edit-categoria').value = wine.Categoria || '';
            document.getElementById('edit-nazione').value = wine.Nazione || '';
            document.getElementById('edit-nome').value = wine.Nome || '';
            document.getElementById('edit-anno').value = wine.Anno || '';
            document.getElementById('edit-aoc').value = wine.AOC || '';
            document.getElementById('edit-vitigni').value = wine.Vitigni || '';
            document.getElementById('edit-prezzo').value = wine.Prezzo || '';
            document.getElementById('edit-giacenza').value = wine.Giacenza || '';
            document.getElementById('edit-descrizione').value = wine.Descrizione || '';
        }

        function closeEditModal() {
            editModal.style.display = 'none';
        }

        cancelButton.addEventListener('click', closeEditModal);

        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nomeOriginale = editNomeOriginale.value;
            const newData = {
                Categoria: document.getElementById('edit-categoria').value,
                Nazione: document.getElementById('edit-nazione').value,
                Nome: document.getElementById('edit-nome').value,
                Anno: document.getElementById('edit-anno').value,
                AOC: document.getElementById('edit-aoc').value,
                Vitigni: document.getElementById('edit-vitigni').value,
                Prezzo: document.getElementById('edit-prezzo').value,
                Giacenza: document.getElementById('edit-giacenza').value,
                Descrizione: document.getElementById('edit-descrizione').value
            };
            
            updateWineData(nomeOriginale, newData)
                .then(success => {
                    if (success) {
                        showMessage('Dati vino aggiornati con successo!', 'success');
                        fetchWines(); // Ricarica i dati dopo l'aggiornamento
                    } else {
                        showMessage('Errore durante l\'aggiornamento dei dati.', 'error');
                    }
                    closeEditModal();
                });
        });
    });
</script>

</body>
</html>
